<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸŽ§ DJ Artwork Generator</title>
  <style>
    body {
      font-family: 'NeueHaasDisplay-Roman', sans-serif;
      background: #0c0c0c;
      color: #fff;
      padding: 20px;
      text-align: center;
    }
    canvas {
      margin: 20px 0;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }
    select, button {
      padding: 10px 16px;
      font-size: 16px;
      border-radius: 8px;
      margin: 10px 5px;
      border: none;
    }
    select { min-width: 200px; }
    .error {
      color: #f66;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>ðŸŽ§ DJ Artwork Generator</h2>

  <div>
    <select id="showPicker" disabled>
      <option value="" disabled selected>-- Loading shows... --</option>
    </select>
    <button id="generateBtn" disabled>Generate Artwork</button>
  </div>
  <div id="errorMsg" class="error"></div>

  <canvas id="artCanvas" width="1080" height="1080"></canvas>
  <br>
  <button id="downloadBtn" disabled>Download Image</button>

  <!-- Dependencies -->
  <script src="https://unpkg.com/psd/dist/psd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>

  <script>
    let templateLayers = null;
    let shows = [];
    const errorMsg = document.getElementById('errorMsg');

    // Fetch show data immediately
    function loadShowData() {
      const url = 'https://script.google.com/macros/s/AKfycbw3QgJtZXB48I0BUMpTE5Dlo2kqMReNuD4jbiEVBaB1z49bSgzEkAgixkjHxwTKRwY0/exec';
      fetch(url)
        .then(response => response.json())
        .then(json => {
          shows = json.filter(r => r['Image URL']?.startsWith('http'));
          const sel = document.getElementById('showPicker');
          sel.innerHTML = '<option value="" disabled selected>-- Select a show --</option>';
          shows.forEach((row, i) => {
            const d = new Date(row['Date']);
            const fmt = d.toLocaleDateString('en-GB', { weekday:'short', day:'numeric', month:'short' });
            sel.appendChild(new Option(`${fmt} - ${row['Now Playing']} (${row['DJ']})`, i));
          });
          sel.disabled = false;
          sel.addEventListener('change', () => {
            document.getElementById('generateBtn').disabled = false;
          });
        })
        .catch(err => {
          console.error('Show data load error:', err);
          const sel = document.getElementById('showPicker');
          sel.innerHTML = '<option disabled>Error loading shows</option>';
          errorMsg.textContent = 'Unable to fetch show list. Check network or JSON URL.';
        });
    }

    // Simple PSD loader without HEAD-check
    function loadTemplate() {
      PSD.fromURL('template.psd')
        .then(psd => {
          psd.parse();
          templateLayers = psd.tree().descendants()
            .filter(node => !node.isGroup())
            .map(node => {
              const isText = !!node.layer.text;
              let textProps = {};
              if (isText) {
                const data = node.get('typeTool').data;
                textProps = {
                  text: data.text.replace(/\r/g, ''),
                  font: data.fontName,
                  size: data.font.sizes[0],
                  color: `rgb(${data.font.colors[0].join(',')})`
                };
              }
              return {
                name: node.name,
                type: isText ? 'text' : 'image',
                x: node.left,
                y: node.top,
                width: node.width,
                height: node.height,
                opacity: node.layer.opacity / 255,
                blendMode: node.blendMode,
                ...textProps,
                imageData: !isText ? node.toPng() : null
              };
            });
          // Clear any previous error
          errorMsg.textContent = '';
          console.log('PSD template loaded successfully');
        })
        .catch(err => {
          console.error('PSD load error:', err);
          errorMsg.textContent = 'Failed to load PSD template. Check that template.psd exists at the site root and has CORS enabled.';
        });
    }

    window.addEventListener('load', () => {
      loadShowData();
      loadTemplate();
    });

    document.getElementById('generateBtn').addEventListener('click', () => {
      if (!templateLayers) {
        alert('Template not loaded yet.');
        return;
      }
      const show = shows[document.getElementById('showPicker').value];
      const canvas = document.getElementById('artCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      templateLayers.forEach(layer => {
        ctx.globalAlpha = layer.opacity;
        ctx.globalCompositeOperation = layer.blendMode || 'source-over';
        if (layer.type === 'image') {
          const img = new Image();
          img.src = layer.imageData;
          img.onload = () => ctx.drawImage(img, layer.x, layer.y, layer.width, layer.height);
        } else {
          ctx.fillStyle = layer.color;
          ctx.font = `${layer.size}px '${layer.font}'`;
          let content = layer.text;
          const key = layer.name.toLowerCase();
          if (key.includes('nowplaying')) content = show['Now Playing'];
          else if (key.includes('dj')) content = show['DJ'];
          else if (key.includes('date')) {
            content = new Date(show['Date'])
              .toLocaleDateString('en-GB', { weekday:'short', day:'numeric', month:'short' })
              + ` @ ${show['A-B']}`;
          }
          ctx.fillText(content, layer.x, layer.y + layer.size);
        }
      });

      setTimeout(() => {
        document.getElementById('downloadBtn').disabled = false;
      }, 500);
    });

    document.getElementById('downloadBtn').addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = 'dj_artwork.png';
      link.href = document.getElementById('artCanvas').toDataURL('image/png');
      link.click();
    });
  </script>
</body>
</html>
